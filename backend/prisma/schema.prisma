// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Message {
  id        String   @id @default(uuid(7))
  text      String
  createdAt DateTime @default(now())
}

// ---------- Enums ----------
enum UserRole {
  MENTEE
  MENTOR
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED_BY_MENTEE
  CANCELLED_BY_MENTOR
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  UNAVAILABLE
}

// ---------- Auth & Core User ----------
model User {
  id           String   @id @default(uuid(7))
  email        String   @unique
  passwordHash String
  role         UserRole
  firstName    String
  lastName     String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  refreshTokens RefreshToken[]
  mentorProfile MentorProfile?
  menteeProfile MenteeProfile?
}

model MentorProfile {
  id     String @id @default(uuid(7))
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio             String  @db.Text
  title           String // e.g., "Senior Software Engineer"
  yearsExperience Int
  hourlyRate      Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")

  // Aggregated rating
  avgRating    Float @default(0)
  totalReviews Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories     MentorCategory[]
  skills         MentorSkill[]
  availabilities Availability[]
  bookings       Booking[]
  reviews        Review[]         @relation("MentorReviews")

  @@index([avgRating])
  @@index([hourlyRate])
}

// ---------- Mentee Profile ----------
model MenteeProfile {
  id     String @id @default(uuid(7))
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio   String? @db.Text
  goals String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings  Booking[]
  reviews   Review[]         @relation("MenteeReviews")
  favorites FavoriteMentor[]
}

// ---------- Categories & Skills ----------
model Category {
  id          String  @id @default(uuid(7))
  name        String  @unique
  description String?
  slug        String  @unique

  mentors MentorCategory[]

  @@index([slug])
}

model MentorCategory {
  mentorId   String
  categoryId String

  mentor   MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  category Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([mentorId, categoryId])
  @@index([categoryId])
}

model Skill {
  id   String @id @default(uuid(7))
  name String @unique

  mentors MentorSkill[]
}

model MentorSkill {
  mentorId String
  skillId  String

  mentor MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  skill  Skill         @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([mentorId, skillId])
  @@index([skillId])
}

// ---------- Calendar & Availability ----------
model Availability {
  id       String        @id @default(uuid(7))
  mentorId String
  mentor   MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  dayOfWeek   Int // 0 = Sunday, 6 = Saturday
  startTime   String // e.g., "09:00"
  endTime     String // e.g., "17:00"
  isRecurring Boolean @default(true)

  // For one-time slots
  specificDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mentorId, dayOfWeek])
}

// ---------- Time Slots (Generated from Availability) ----------
model TimeSlot {
  id       String @id @default(uuid(7))
  mentorId String

  startTime DateTime
  endTime   DateTime
  status    SlotStatus @default(AVAILABLE)

  booking Booking?

  @@index([mentorId, startTime, status])
  @@index([status, startTime])
}

// ---------- Bookings ----------
model Booking {
  id String @id @default(uuid(7))

  mentorId String
  mentor   MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   MenteeProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  timeSlotId String   @unique
  timeSlot   TimeSlot @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)

  status BookingStatus @default(PENDING)
  notes  String?       @db.Text

  // Price snapshot
  hourlyRate  Decimal @db.Decimal(10, 2)
  duration    Int // minutes
  totalAmount Decimal @db.Decimal(10, 2)
  currency    String

  meetingLink String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  review Review?

  @@index([mentorId, status])
  @@index([menteeId, status])
  @@index([status, createdAt])
}

// ---------- Reviews & Ratings ----------
model Review {
  id String @id @default(uuid(7))

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  mentorId String
  mentor   MentorProfile @relation("MentorReviews", fields: [mentorId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   MenteeProfile @relation("MenteeReviews", fields: [menteeId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mentorId, rating])
}

// ---------- Favorites ----------
model FavoriteMentor {
  id String @id @default(uuid(7))

  menteeId String
  mentee   MenteeProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  mentorId String

  createdAt DateTime @default(now())

  @@unique([menteeId, mentorId])
  @@index([menteeId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @db.VarChar(500)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@unique([token])
  @@map("refreshtoken")
}
